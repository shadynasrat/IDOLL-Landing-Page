<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IDOLL — Early Access</title>
    <meta name="description" content="Request early access to IDOLL and enter your invite code to start using the web app." />
    <link rel="icon" href="/static/favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { ink: '#121826', night: '#0b0f17' },
            boxShadow: { glow: '0 0 0 2px rgba(255,255,255,0.15), 0 10px 40px rgba(0,0,0,0.35)' }
          }
        }
      }
    </script>
    <style>
      .bg-aurora { background: radial-gradient(1200px 800px at 10% 10%, rgba(255, 94, 247, 0.25), transparent 40%),
                                   radial-gradient(900px 600px at 90% 20%, rgba(0, 164, 255, 0.20), transparent 40%),
                                   radial-gradient(1000px 700px at 50% 100%, rgba(255, 196, 0, 0.18), transparent 40%),
                                   linear-gradient(180deg, #0b0f17 0%, #121826 100%); }
      .glass { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); }
      .hairline { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent); }
    </style>
  </head>
  <body class="bg-aurora text-white min-h-screen">
    <script>
      // Configure API and WS base for cross-origin use (align with server settings)
      window.IDOLL_API_BASE = 'https://idoll.ngrok.app/api';
      window.IDOLL_WS = 'wss://idoll.ngrok.app/ws';
    </script>
    <script>
      // Warn if Google client ID is not configured on API
      (async () => {
        try {
          const base = (window.IDOLL_API_BASE || '/api').replace(/\/$/, '');
          const res = await fetch(base + '/auth/google/client-id', { credentials: 'include' });
          if (!res.ok) return;
          const { client_id } = await res.json();
          if (!client_id) console.warn('[IDOLL] GOOGLE_CLIENT_ID is not set on API. Google button disabled.');
        } catch {}
      })();
    </script>
    <header class="max-w-4xl mx-auto px-5 pt-5">
      <div class="glass rounded-2xl px-4 py-3 flex items-center justify-between">
        <a href="/" class="inline-flex items-center gap-3">
          <img src="./static/images/logo-white.png" alt="IDOLL" class="h-8 w-auto" />
          <span class="sr-only">IDOLL</span>
        </a>
        <nav class="text-sm text-white/70 hidden sm:flex gap-6">
          <a href="/index.html#join" class="hover:text-white">Waitlist</a>
          <a href="#invite" class="hover:text-white">Enter Invite</a>
        </nav>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-5 pt-10 pb-20">
      <section class="grid md:grid-cols-2 gap-10 items-start">
        <div>
          <span class="inline-flex items-center gap-2 text-xs rounded-full bg-white/10 border border-white/20 px-3 py-1">
            <span class="size-2 rounded-full bg-emerald-400 animate-pulse"></span>
            Early Access • Private Beta
          </span>
          <h1 class="mt-4 text-4xl sm:text-5xl font-black leading-tight">Be first to meet IDOLL</h1>
          <p class="mt-4 text-white/80">Enter your email and invite code to unlock Early Access. We’ll set a secure session on this device and take you to the app.</p>

          <div class="mt-6 flex flex-wrap gap-3">
            <a href="/index.html#join" class="inline-flex items-center rounded-full bg-white text-ink px-5 py-3 font-medium hover:opacity-95">Request access</a>
            <a href="#invite" class="inline-flex items-center rounded-full border border-white/30 px-5 py-3 font-medium hover:bg-white/10">I have an invite</a>
          </div>

          <div class="mt-8 text-xs text-white/60">Problems with your code? Email support@idoll.love with your invite ID.</div>

          
        </div>

        <div id="invite" class="glass rounded-2xl p-5">
          <h2 class="text-xl font-semibold">Enter invite code</h2>
          <p class="text-sm text-white/70 mt-1">Use the code from your email to unlock the web app.</p>
          <div id="already-approved" class="hidden mt-3 text-emerald-300 text-sm">
            Access already granted on this device. <a href="./webapp.html" class="underline">Continue to IDOLL</a>.
          </div>
          <!-- Method Toggle -->
          <div class="mt-4 inline-flex rounded-full bg-white/10 border border-white/20 p-1" role="tablist" aria-label="Access method">
            <button id="method-google" type="button" class="px-3 py-1.5 text-sm rounded-full hover:bg-white/10 focus:outline-none">Google</button>
            <button id="method-email" type="button" class="px-3 py-1.5 text-sm rounded-full hover:bg-white/10 focus:outline-none">Email</button>
          </div>

          <!-- Google Sign-In block -->
          <div id="google-signin-block" class="mt-3">
            <div id="google-btn"></div>
            <p class="text-xs text-white/50 mt-2">Sign in with Google, then enter your invite code.</p>
          </div>
          <form id="invite-form" class="mt-4 space-y-3">
            <div id="email-block">
              <label for="email" class="block text-sm mb-1">Email</label>
              <input id="email" name="email" type="email" placeholder="you@example.com" class="w-full rounded-xl bg-white/10 border border-white/20 px-3 py-2 outline-none focus:ring-2 focus:ring-white/40" />
            </div>
            <div>
              <label for="code" class="block text-sm mb-1">Invite code</label>
              <input id="code" name="code" type="text" required placeholder="e.g. IDOLL-ALPHA-2024" class="w-full uppercase tracking-wider rounded-xl bg-white/10 border border-white/20 px-3 py-2 outline-none focus:ring-2 focus:ring-white/40" />
              <p class="text-xs text-white/50 mt-1">Case-insensitive; dashes optional.</p>
            </div>
            <button type="submit" class="w-full rounded-full bg-white text-ink px-5 py-2.5 font-medium hover:opacity-95">Continue</button>
            <p id="error" class="hidden text-rose-300 text-sm"></p>
          </form>
        </div>
      </section>

      <div class="mt-16 hairline"></div>
      <section class="mt-10">
        <h3 class="text-lg font-semibold">No invite yet?</h3>
        <p class="text-white/70 mt-1">Join the waitlist and we’ll reach out as capacity opens.</p>
        <a href="/index.html#join" class="mt-4 inline-flex items-center rounded-full bg-white text-ink px-5 py-2.5 font-medium hover:opacity-95">Join the waitlist</a>
      </section>
    </main>

    <script src="./static/js/auth_client.js"></script>
    <script>
      // Auto show error if redirected from denied
      const params = new URLSearchParams(location.search);
      const denied = params.get('denied');
      const error = document.getElementById('error');

      if (denied) {
        error.textContent = 'Early access required. Please enter your invite code or request access.';
        error.classList.remove('hidden');
        // If user is already approved, hide the error to avoid mixed messages
        (async () => {
          try {
            const base = (window.IDOLL_API_BASE || '/api').replace(/\/$/, '');
            const res = await fetch(base + '/auth/session', { credentials: 'include' });
            const sess = await res.json();
            if (sess && sess.authenticated && sess.user && sess.user.role === 'early_access') {
              error.classList.add('hidden');
            }
          } catch {}
        })();
      }

      // Access method toggle logic
      document.addEventListener('DOMContentLoaded', () => {
        const methodGoogleBtn = document.getElementById('method-google');
        const methodEmailBtn = document.getElementById('method-email');
        const googleBlock = document.getElementById('google-signin-block');
        const emailBlock = document.getElementById('email-block');
        const emailInput = document.getElementById('email');
        let userChose = false;

        function setActive(btn) {
          [methodGoogleBtn, methodEmailBtn].forEach(b => b.classList.remove('bg-white','text-ink'));
          btn.classList.add('bg-white','text-ink');
        }

        function chooseGoogle() {
          googleBlock.style.display = '';
          emailBlock.style.display = 'none';
          emailInput.removeAttribute('required');
          setActive(methodGoogleBtn);
        }

        function chooseEmail() {
          googleBlock.style.display = 'none';
          emailBlock.style.display = '';
          emailInput.setAttribute('required','true');
          setActive(methodEmailBtn);
        }

        methodGoogleBtn.addEventListener('click', () => { userChose = true; chooseGoogle(); });
        methodEmailBtn.addEventListener('click', () => { userChose = true; chooseEmail(); });

        // Default to Email; if Google client ID is available, switch to Google unless user already chose
        chooseEmail();
        (async () => {
          try {
            if (window.IDOLL_GOOGLE_CLIENT_ID) { if (!userChose) chooseGoogle(); return; }
            const base = (window.IDOLL_API_BASE || '/api').replace(/\/$/, '');
            const resp = await fetch(base + '/auth/google/client-id', { credentials: 'include' });
            if (!resp.ok) return;
            const { client_id } = await resp.json();
            if (client_id && !userChose) chooseGoogle();
          } catch {}
        })();
      });
    </script>
  </body>
</html>
